accedo.define("nfb.controllers.mostviewedSubcontroller",["nfb.views.mostviewedSubview","accedo.utils.object","accedo.ui.controller"],function(){return function(opts){return accedo.utils.object.extend(accedo.ui.controller(opts),{onCreate:function(){var self=this;self.setView(nfb.views.mostviewedSubview);accedo.app.getCurrentController().get("loading_subcontroller").root.setStyle({display:"block"});var result_group=[];var result;var no;var total_no;var start_id;var focus_id;var current_block=0;var list=[];list=[this.get("list1"),this.get("list2"),this.get("list3")];var list_fav=[];list_fav=[this.get("list1_fav"),this.get("list2_fav"),this.get("list3_fav")];var up_btn=this.get("most_up");var down_btn=this.get("most_down");var channel=this.get("channel_name");var result_label=this.get("result");var layer=accedo.app.getCurrentController().get("layer");var no_fav=this.get("no_fav");var line=[this.get("line1"),this.get("line2"),this.get("line3"),this.get("line4")];up_btn.setSrc("image/up.png");if(nfb.config.currentSubcontroller==1){try{result=SERVER.getJSON(nfb.config.url+nfb.config.API_mostviewed+nfb.config.API_key+nfb.config.API_key1+"&qte=30");}catch(e){alert("ERROR:unable to connect the server.Please try again.");this.get("mostviewedSubview").hide();accedo.utils.fn.delay(function(){accedo.focus.manager.requestFocus(accedo.app.getCurrentController().get("cat2"));},0.01);return;}list[0].setOption("nextLeft","cat2");list[1].setOption("nextLeft","cat2");list[2].setOption("nextLeft","cat2");no=result.data.length;total_no=result.data_length;start_id=nfb.config.mostview_start_id.pop();focus_id=nfb.config.mostview_focus_id.pop();document.body.setAttribute("style","background-image:url('image/bg.jpg'); background-repeat: no-repeat;background-size: 1280px 622px");}else{if(nfb.config.currentSubcontroller==2){start_id=nfb.config.fav_start_id.pop();focus_id=nfb.config.fav_focus_id.pop();list[0].setOption("nextLeft","cat3");list[1].setOption("nextLeft","cat3");list[2].setOption("nextLeft","cat3");var size=localStorage.getItem("fav");if(size==null||size==""){no=0;}else{var fav_list=JSON.parse(localStorage.getItem("fav"));total_no=fav_list.length;}for(var i=0;i<total_no;i++){var vvitem=JSON.parse(localStorage.getItem(fav_list[i]));result_group[total_no-1-i]={film:fav_list[i],year:vvitem.year,title:vvitem.title,time:vvitem.length,thumbnail:vvitem.thumbnail,director:vvitem.director};}document.body.setAttribute("style","background-image:url(image/bg_fav.jpg); background-repeat: no-repeat;background-size: 1280px 622px");}else{if(nfb.config.currentSubcontroller==4){list[0].setOption("nextLeft","cat5");list[1].setOption("nextLeft","cat5");list[2].setOption("nextLeft","cat5");start_id=nfb.config.kid_start_id.pop();focus_id=nfb.config.kid_focus_id.pop();try{result=SERVER.getJSON(nfb.config.url+nfb.config.API_kid+nfb.config.API_key+nfb.config.API_key1+"&qte=30");}catch(e){alert("ERROR:unable to connect the server.Please try again.");this.get("mostviewedSubview").hide();accedo.utils.fn.delay(function(){accedo.focus.manager.requestFocus(accedo.app.getCurrentController().get("cat5"));},0.01);return;}total_no=result.data_length;no=result.data.length;document.body.setAttribute("style","background-image:url("+nfb.config.angrybird+"); background-repeat: no-repeat;background-size: 1280px 622px");}else{if(nfb.config.currentSubcontroller==9){list[0].setOption("nextLeft","cat4");list[1].setOption("nextLeft","cat4");list[2].setOption("nextLeft","cat4");document.body.setAttribute("style","background-image:url('image/bg.jpg'); background-repeat: no-repeat;background-size: 1280px 622px");start_id=nfb.config.channel_result_start_id.pop();focus_id=nfb.config.channel_result_focus_id.pop();try{result=SERVER.getJSON(nfb.config.url+nfb.config.API_channelpre+nfb.config.API_channelid+nfb.config.API_key+nfb.config.API_key1+"&qte=30");}catch(e){alert("ERROR:unable to connect the server.Please try again.");this.get("mostviewedSubview").hide();accedo.utils.fn.delay(function(){accedo.focus.manager.requestFocus(accedo.app.getCurrentController().get("cat4"));},0.01);return;}channel.setText(nfb.config.temp);channel.show();no=result.data.length;total_no=result.data_length;}else{if(nfb.config.currentSubcontroller==10){list[0].setOption("nextLeft","cat6");list[1].setOption("nextLeft","cat6");list[2].setOption("nextLeft","cat6");document.body.setAttribute("style","background-image:url('image/bg.jpg'); background-repeat: no-repeat;background-size: 1280px 622px");try{result=SERVER.getJSON(nfb.config.url+nfb.config.API_search+nfb.config.search_lang+nfb.config.API_key+nfb.config.API_key1+"&search_keywords="+encodeURIComponent(nfb.config.search));}catch(e){alert("ERROR:unable to connect the server.Please try again.");this.get("mostviewedSubview").hide();accedo.utils.fn.delay(function(){accedo.focus.manager.requestFocus(accedo.app.getCurrentController().get("cat6"));},0.01);return;}if(localStorage.getItem("zlang")=="en"){channel.setText("Search Result of "+nfb.config.search);}else{channel.setText("Résultats de "+nfb.config.search);}channel.show();no=result.data.length;start_id=nfb.config.search_start_id.pop();focus_id=nfb.config.search_focus_id.pop();total_no=no;}else{if(nfb.config.currentSubcontroller==8){var title1=chop(nfb.config.temp,38);if(localStorage.getItem("zlang")=="fr"){channel.setText("Films reli&eacute;s : "+title1);}else{channel.setText("Related films : "+title1);}channel.show();layer.show();result=nfb.config.temp_film;document.body.setAttribute("style","background-image:url("+result.data.film.big_thumbnail+"); background-repeat: no-repeat;background-size: 1280px 622px");start_id=nfb.config.related_start_id.pop();focus_id=nfb.config.related_focus_id.pop();no=result.data.related_content.length;total_no=no;}}}}}}show_result_no();for(var k=0;k<list_fav.length;k++){list[k].hide();list_fav[k].hide();}save(no);update();pageupdown();list[0].onFocus=function(){show_result_no();current_block=0;focus_id=parseInt(list[0].root.getHTMLElement().getAttribute("alt"));accedo.device.manager.unregisterKey("down");if(focus_id>0){accedo.device.manager.unregisterKey("up");accedo.device.manager.registerKey("up",function(){start_id=start_id-1;update();accedo.focus.manager.requestFocus(list[0]);});}else{accedo.device.manager.unregisterKey("up");accedo.device.manager.registerKey("up",function(){accedo.focus.manager.requestFocus(list[0]);});}if(result_group.length==1){accedo.device.manager.unregisterKey("up");accedo.device.manager.registerKey("up",function(){});accedo.device.manager.unregisterKey("down");accedo.device.manager.registerKey("down",function(){});}};list[1].onFocus=function(){focus_id=parseInt(list[1].root.getHTMLElement().getAttribute("alt"));current_block=1;show_result_no();if(result_group.length==2){accedo.device.manager.unregisterKey("up");accedo.device.manager.unregisterKey("down");accedo.device.manager.registerKey("down",function(){});list[1].setOption("nextDown","");}else{accedo.device.manager.unregisterKey("up");accedo.device.manager.unregisterKey("down");list[1].setOption("nextDown","list3");}};list[2].onFocus=function(){show_result_no();focus_id=parseInt(list[2].root.getHTMLElement().getAttribute("alt"));current_block=2;accedo.device.manager.unregisterKey("up");if(focus_id<total_no-1){accedo.device.manager.unregisterKey("down");accedo.device.manager.registerKey("down",function(){start_id=start_id+1;update();accedo.focus.manager.requestFocus(list[2]);});}else{accedo.device.manager.unregisterKey("down");accedo.device.manager.registerKey("down",function(){accedo.focus.manager.requestFocus(list[2]);});}};for(var l=0;l<3;l++){list[l].removeAll("click");list[l].addEventListener("click",function(){nfb.config.history.push(nfb.config.currentSubcontroller);if(nfb.config.currentSubcontroller==1){nfb.config.mostview_start_id.push(start_id);nfb.config.mostview_focus_id.push(current_block+1);}else{if(nfb.config.currentSubcontroller==4){nfb.config.kid_start_id.push(start_id);nfb.config.kid_focus_id.push(current_block+1);}else{if(nfb.config.currentSubcontroller==8){nfb.config.related_start_id.push(start_id);nfb.config.related_focus_id.push(current_block+1);nfb.config.related_result.push(nfb.config.film);}else{if(nfb.config.currentSubcontroller==10){nfb.config.search_start_id.push(start_id);nfb.config.search_focus_id.push(current_block+1);}else{if(nfb.config.currentSubcontroller==2){nfb.config.fav_start_id.push(start_id);nfb.config.fav_focus_id.push(current_block+1);}else{if(nfb.config.currentSubcontroller==9){nfb.config.channel_result_start_id.push(start_id);nfb.config.channel_result_focus_id.push(current_block+1);}}}}}}nfb.config.film=result_group[focus_id].film;accedo.app.getCurrentController().get("subcontroller").changeToController(nfb.controllers.detailviewSubcontroller);});}list[0].root.addEventListener("mouseout",function(){list[0].blur();});list[1].root.addEventListener("mouseout",function(){list[1].blur();});list[2].root.addEventListener("mouseout",function(){list[2].blur();});list_fav[0].root.addEventListener("mouseout",function(){list_fav[0].blur();});list_fav[1].root.addEventListener("mouseout",function(){list_fav[1].blur();});list_fav[2].root.addEventListener("mouseout",function(){list_fav[2].blur();});down_btn.addEventListener("click",function(){if(start_id+1<total_no-2){start_id=start_id+1;update();show_result_no();accedo.focus.manager.requestFocus(down_btn);}if(start_id+1==total_no-2){down_btn.blur();down_btn.hide();}});down_btn.root.addEventListener("click",function(){if(start_id+1<total_no-2){start_id=start_id+1;update();show_result_no();accedo.focus.manager.requestFocus(down_btn);}if(start_id+1==total_no-2){down_btn.blur();down_btn.hide();}});up_btn.addEventListener("click",function(){if(start_id-1>-1){start_id=start_id-1;update();show_result_no();accedo.focus.manager.requestFocus(up_btn);}if(start_id-1==-1){up_btn.blur();up_btn.hide();}});up_btn.root.addEventListener("click",function(){if(start_id-1>-1){start_id=start_id-1;update();show_result_no();accedo.focus.manager.requestFocus(up_btn);}if(start_id-1==-1){up_btn.blur();up_btn.hide();}});up_btn.root.addEventListener("mouseout",function(){up_btn.blur();});down_btn.root.addEventListener("mouseout",function(){down_btn.blur();});up_btn.onFocus=function(){up_btn.setSrc("image/up_focus.png");};up_btn.onBlur=function(){up_btn.setSrc("image/up.png");};down_btn.onFocus=function(){down_btn.setSrc("image/down_focus.png");};down_btn.onBlur=function(){down_btn.setSrc("image/down.png");};function update(){if(start_id<=0){up_btn.hide();}else{up_btn.show();up_btn.setSrc("image/up.png");}if(start_id+2==total_no-1){down_btn.hide();}else{down_btn.show();down_btn.setSrc("image/down.png");}if(start_id+3>=no&&no<total_no){accedo.app.getCurrentController().get("loading_subcontroller").root.setStyle({display:"block"});if(nfb.config.currentSubcontroller==1){result=SERVER.getJSON(nfb.config.url+nfb.config.API_mostviewed+nfb.config.API_key+nfb.config.API_key1+"&at_index="+no+"&qte=30");}else{if(nfb.config.currentSubcontroller==4){result=SERVER.getJSON(nfb.config.url+nfb.config.API_kid+nfb.config.API_key+nfb.config.API_key1+"&at_index="+no+"&qte=30");}else{if(nfb.config.currentSubcontroller==9){result=SERVER.getJSON(nfb.config.url+nfb.config.API_channelpre+nfb.config.API_channelid+nfb.config.API_key+nfb.config.API_key1+"&at_index="+no+"&qte=30");}}}no=no+result.data.length;save(result.data.length);accedo.app.getCurrentController().get("loading_subcontroller").root.setStyle({display:"none"});}if(result_group.length<0||result_group.length==null||result_group.length==""){line[0].hide();line[1].hide();line[2].hide();line[3].hide();result_label.hide();down_btn.hide();}if(result_group.length==0){if(nfb.config.currentSubcontroller==2){if(localStorage.getItem("zlang")=="en"){no_fav.setText("Welcome to your Favourites page.<br>To add a film to your list of Favourites, click on the star icon next to the film.");}else{if(localStorage.getItem("zlang")=="fr"){no_fav.setText("Bienvenue à votre page de Favoris.<br>Pour ajouter un film à votre liste de Favoris, cliquez sur l’étoile à la droite du film.");}}}else{if(nfb.config.currentSubcontroller==10){if(localStorage.getItem("zlang")=="en"){no_fav.setText("No results");}else{if(localStorage.getItem("zlang")=="fr"){no_fav.setText("Aucun résultat");}}accedo.utils.fn.delay(function(){accedo.focus.manager.requestFocus(accedo.app.getCurrentController().get("cat6"));},0.1);}}line[0].hide();line[1].hide();line[2].hide();line[3].hide();result_label.hide();down_btn.hide();accedo.utils.fn.delay(function(){accedo.focus.manager.requestFocus(accedo.app.getCurrentController().get("cat3"));},0.01);}else{if(result_group.length==1){line[3].hide();line[2].hide();down_btn.hide();}else{if(result_group.length==2){line[3].hide();down_btn.hide();}else{if(result_group.length==3){down_btn.hide();}}}}initializeFav();var current_id=start_id;for(var i=0;i<3;i++){if(result_group.length>i){list[i].show();list_fav[i].show();var new_time=time_t(result_group[current_id].time);var new_title=chop(result_group[current_id].title,30);var new_director=chop(result_group[current_id].director,30);list[i].setAlt(current_id);list[i].setName(result_group[current_id].film);list[i].setThumb(result_group[current_id].thumbnail);list[i].setTitle(new_title);list[i].setTime(new_time+", "+result_group[current_id].year);list[i].setDirector(new_director);current_id++;}}}this.addEventListener("attach",function(){});this.addEventListener("detach",function(){});function getItem(vindex){if(nfb.config.currentSubcontroller==8){return{title:result.data.related_content[vindex].title,thumbnail:result.data.related_content[vindex].thumbnail,length:result.data.related_content[vindex].time,year:result.data.related_content[vindex].year,director:result.data.related_content[vindex].director[0].slug};}else{return{title:result_group[vindex].title,thumbnail:result_group[vindex].thumbnail,length:result_group[vindex].time,year:result_group[vindex].year,director:result_group[vindex].director};}}function initializeFav(){if(result_group.length>0){if(localStorage.getItem(result_group[start_id].film)){list_fav[0].setSrc("image/fav.png");}else{list_fav[0].setSrc("image/unfav.png");}}if(result_group.length>1){if(localStorage.getItem(result_group[start_id+1].film)){list_fav[1].setSrc("image/fav.png");}else{list_fav[1].setSrc("image/unfav.png");}}if(result_group.length>2){if(localStorage.getItem(result_group[start_id+2].film)){list_fav[2].setSrc("image/fav.png");}else{list_fav[2].setSrc("image/unfav.png");}}for(var i=0;i<3;i++){if(result_group.length>i){var vid;if(nfb.config.currentSubcontroller!=2){if(nfb.config.currentSubcontroller==8){vid=result.data.related_content[start_id+i].slug;}else{vid=result_group[start_id+i].slug;}}else{vid=result_group[start_id+i].film;}}}list_fav[0].onFocus=function(){if(localStorage.getItem(result_group[start_id].film)){list_fav[0].setSrc("image/fav_focused.png");}else{list_fav[0].setSrc("image/unfav_focus.png");}};list_fav[0].onBlur=function(){if(localStorage.getItem(result_group[start_id].film)){list_fav[0].setSrc("image/fav.png");}else{list_fav[0].setSrc("image/unfav.png");}};list_fav[1].onFocus=function(){if(localStorage.getItem(result_group[start_id+1].film)){list_fav[1].setSrc("image/fav_focused.png");}else{list_fav[1].setSrc("image/unfav_focus.png");}};list_fav[1].onBlur=function(){if(localStorage.getItem(result_group[start_id+1].film)){list_fav[1].setSrc("image/fav.png");}else{list_fav[1].setSrc("image/unfav.png");}};list_fav[2].onFocus=function(){if(localStorage.getItem(result_group[start_id+2].film)){list_fav[2].setSrc("image/fav_focused.png");}else{list_fav[2].setSrc("image/unfav_focus.png");}};list_fav[2].onBlur=function(){if(localStorage.getItem(result_group[start_id+2].film)){list_fav[2].setSrc("image/fav.png");}else{list_fav[2].setSrc("image/unfav.png");}};}function add_fav(film_id){var size=localStorage.getItem("fav");if(size==null||size==""){var temp11=new Array();}else{var temp11=JSON.parse(localStorage.getItem("fav"));}temp11.push(film_id);localStorage.setItem("fav",JSON.stringify(temp11));}function del_fav(film_id1){var size1=localStorage.getItem("fav");if(size1==null||size1==""){var temp12=new Array();}else{var temp12=JSON.parse(localStorage.getItem("fav"));var in1=temp12.indexOf(film_id1);temp12.splice(in1,1);}localStorage.setItem("fav",JSON.stringify(temp12));}function fav0listener(){var currentId;if(nfb.config.currentSubcontroller!=2){currentId=result_group[start_id].film;if(localStorage.getItem(currentId)){localStorage.removeItem(currentId);del_fav(currentId);list_fav[0].setSrc("image/unfav_focus.png");}else{localStorage.setItem(currentId,JSON.stringify(getItem(start_id)));add_fav(currentId);list_fav[0].setSrc("image/fav_focused.png");}}else{currentId=result_group[start_id].film;if(localStorage.getItem(currentId)){localStorage.removeItem(currentId);list_fav[0].setSrc("image/unfav_focus.png");del_fav(currentId);}else{localStorage.setItem(currentId,JSON.stringify({title:result_group[start_id].title,thumbnail:result_group[start_id].thumbnail,length:result_group[start_id].time,year:result_group[start_id].year}));add_fav(currentId);list_fav[0].setSrc("image/fav_focused.png");}}}function fav1listener(){var currentId;if(nfb.config.currentSubcontroller!=2){currentId=result_group[start_id+1].film;if(localStorage.getItem(currentId)){localStorage.removeItem(currentId);list_fav[1].setSrc("image/unfav_focus.png");del_fav(currentId);}else{localStorage.setItem(currentId,JSON.stringify(getItem(start_id+1)));add_fav(currentId);list_fav[1].setSrc("image/fav_focused.png");}}else{currentId=result_group[start_id+1].film;if(localStorage.getItem(currentId)){localStorage.removeItem(currentId);list_fav[1].setSrc("image/unfav_focus.png");del_fav(currentId);}else{localStorage.setItem(currentId,JSON.stringify({title:result_group[start_id+1].title,thumbnail:result_group[start_id+1].thumbnail,length:result_group[start_id+1].time,year:result_group[start_id+1].year}));add_fav(currentId);list_fav[1].setSrc("image/fav_focused.png");}}}function fav2listener(){var currentId;if(nfb.config.currentSubcontroller!=2){currentId=result_group[start_id+2].film;if(localStorage.getItem(currentId)){localStorage.removeItem(currentId);list_fav[2].setSrc("image/unfav_focus.png");del_fav(currentId);}else{localStorage.setItem(currentId,JSON.stringify(getItem(start_id+2)));add_fav(currentId);list_fav[2].setSrc("image/fav_focused.png");}}else{currentId=result_group[start_id+2].film;if(localStorage.getItem(currentId)){localStorage.removeItem(currentId);list_fav[2].setSrc("image/unfav_focus.png");del_fav(currentId);}else{localStorage.setItem(currentId,JSON.stringify({title:result_group[start_id+2].title,thumbnail:result_group[start_id+2].thumbnail,length:result_group[start_id+2].time,year:result_group[start_id+2].year}));add_fav(currentId);list_fav[2].setSrc("image/fav_focused.png");}}}list_fav[0].addEventListener("click",fav0listener);list_fav[1].addEventListener("click",fav1listener);list_fav[2].addEventListener("click",fav2listener);list_fav[0].root.addEventListener("click",fav0listener);list_fav[1].root.addEventListener("click",fav1listener);list_fav[2].root.addEventListener("click",fav2listener);accedo.app.getCurrentController().get("loading_subcontroller").root.setStyle({display:"none"});function show_result_no(){var temp1;if(eval(start_id+3)>total_no){temp1=total_no;}else{temp1=eval(start_id+3);}if(localStorage.getItem("zlang")=="fr"){result_label.setText(eval(start_id+1)+"-"+temp1+" sur "+total_no+" films");}else{result_label.setText(eval(start_id+1)+"-"+temp1+" of "+total_no+" films");}}function pageupdown(){accedo.device.manager.unregisterKey("pagedown");accedo.device.manager.registerKey("pagedown",function(){if(current_block==0){accedo.focus.manager.requestFocus(list[1]);}else{if(current_block==1){accedo.focus.manager.requestFocus(list[2]);}else{if(start_id+1<total_no-2){start_id=start_id+1;update();}}}accedo.focus.manager.requestFocus(list[2]);});accedo.device.manager.unregisterKey("pageup");accedo.device.manager.registerKey("pageup",function(){if(current_block==2){accedo.focus.manager.requestFocus(list[1]);}else{if(current_block==1){accedo.focus.manager.requestFocus(list[0]);}else{if(start_id-1>-1){start_id=start_id-1;update();}}}accedo.focus.manager.requestFocus(list[0]);});}function chop(word,length){var tem=word.replace(/<.*?>/g,"");if(tem.length>length){if(tem.indexOf(" ",length)>0){tem=tem.substr(0,tem.indexOf(" ",length));tem=tem+" (...)";}}return tem;}function time_t(input){var min=0;var sec=0;var separate=input.split(" ").join("");if(separate.indexOf("min")>0){var temp=separate.split("min");min=parseInt(temp[0]);}if(separate.indexOf("s")>0){sec=parseInt(temp[1].split("s")[0]);}if(min<10){min="0"+min;}if(sec<10){sec="0"+sec;}return min+":"+sec;}function save(qte){for(var p=0;p<qte;p++){if(nfb.config.currentSubcontroller==8){var temp3={film:result.data.related_content[p].slug,year:result.data.related_content[p].year,title:result.data.related_content[p].title,time:result.data.related_content[p].time,thumbnail:result.data.related_content[p].thumbnail,director:result.data.related_content[p].director[0].slug};result_group.push(temp3);}else{if(nfb.config.currentSubcontroller!=2){var temp={film:result.data[p].slug,year:result.data[p].year,title:result.data[p].title,time:result.data[p].time,thumbnail:result.data[p].thumbnail,director:result.data[p].director};result_group.push(temp);}}}}}});};});